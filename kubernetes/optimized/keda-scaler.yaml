apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: llm-optimized-scaler
  labels:
    app: llm-optimized
spec:
  scaleTargetRef:
    name: llm-optimized
  minReplicaCount: 1
  maxReplicaCount: 10
  pollingInterval: 30
  cooldownPeriod: 300
  triggers:
  - type: prometheus
    metadata:
      serverAddress: http://prometheus-service:9090
      metricName: vllm_requests_per_second
      query: rate(vllm_requests_total[2m])
      threshold: "10"
  - type: prometheus
    metadata:
      serverAddress: http://prometheus-service:9090
      metricName: gpu_utilization
      query: avg(rate(nvidia_gpu_utilization[2m]))
      threshold: "80"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: keda-prometheus-config
data:
  prometheus.yaml: |
    global:
      scrape_interval: 15s
    scrape_configs:
    - job_name: 'llm-optimized'
      static_configs:
      - targets: ['llm-optimized-service:8001']
